version: '3.8'
services:
  eureka-server:
    build: ./eureka
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8761/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: always

  grades-microservice:
    build: ./grades-ms
    container_name: grades-microservice
    ports:
      - "8081:8081"
    networks:
      - microservices-network
    environment:
      - SERVER_PORT=8081
      # Aseguramos que se registre con IP
      - JAVA_TOOL_OPTIONS=-Deureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/ -Deureka.instance.preferIpAddress=true
    depends_on:
      eureka-server:
        condition: service_healthy
    restart: always

  students-microservice:
    build: ./students-ms
    container_name: students-microservice
    ports:
      - "8080:8080"
    networks:
      - microservices-network
    environment:
      - SERVER_PORT=8080
      # AQUÍ ESTÁ EL TRUCO QUE YA FUNCIONA:
      - JAVA_TOOL_OPTIONS=-Deureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/ -Deureka.instance.preferIpAddress=true -Dgrades-ms.ribbon.listOfServers=http://grades-microservice:8081 -Dgrades-microservice.ribbon.listOfServers=http://grades-microservice:8081
    depends_on:
      eureka-server:
        condition: service_healthy
      grades-microservice:
        condition: service_started
    restart: always

  gateway-service:
    build: ./gateway
    container_name: gateway-service
    ports:
      - "8082:8082"
    networks:
      - microservices-network
    environment:
      - SERVER_PORT=8082
      - JAVA_TOOL_OPTIONS=-Deureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/ -Deureka.instance.preferIpAddress=true
    depends_on:
      eureka-server:
        condition: service_healthy
      students-microservice:
        condition: service_started
      grades-microservice:
        condition: service_started
    restart: always

  # --- AQUÍ ESTÁ LO NUEVO: EL FRONTEND ---
  frontend-service:
    build: ./frontend
    container_name: frontend-service
    ports:
      - "3000:80"  # Accederás en tu navegador por el puerto 3000
    networks:
      - microservices-network
    depends_on:
      gateway-service:
        condition: service_started
    restart: always

networks:
  microservices-network:
    driver: bridge